<html lang="zh-CN"><head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="theme-color" content="#fff0f5">
	<title>ğŸŒ¸ æ¨±èŠ±ç¥åº§Â·è‘µ</title>
	<style>
		/* === 1. è§†è§‰ç³»ç»Ÿï¼šç¥åŸŸå°‘å¥³ (Divine Maiden) === */
		:root {
			/* è‘µçš„ä¸“å±è‰²è°± */
			--primary: #ff80ab; --primary-dark: #c51162;
			--accent: #b388ff; --bg: #fff0f5; 
			--surface: rgba(255, 255, 255, 0.94);
			--glass: blur(40px);
			--text: #4a3b40; --sub: #908085;
			--radius: 24px;
			--safe-top: env(safe-area-inset-top);
			--safe-bottom: env(safe-area-inset-bottom);
			
			/* 2025 æ–°è¯¾æ ‡å­¦ç§‘è‰²è°± (ç³–æœè‰²) */ --c-mat: #4fc3f7; --c-eng: #ce93d8; --c-chn: #f48fb1;
			--c-phy: #9575cd; --c-che: #ff8a65; --c-bio: #a5d6a7;
			--c-pol: #e57373; --c-his: #8d6e63; --c-geo: #4db6ac;
		}

		* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
		
		body {
			font-family: "PingFang SC", "Microsoft YaHei", system-ui, -apple-system, sans-serif;
			margin: 0; background: var(--bg); color: var(--text);
			height: 100vh; display: flex; flex-direction: column; overflow: hidden;
			background-image: radial-gradient(circle at 50% 0%, #ffffff 0%, #fff0f5 100%);
		}

		/* ğŸŒ¸ ç‰©ç†å¼•æ“æ¨±èŠ± */
		#sakuraCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }

		/* === 2. é¡¶éƒ¨çµåŠ¨å²› === */
		.header {padding: 10px 20px; padding-top: calc(10px + var(--safe-top));
			background: var(--surface); backdrop-filter: var(--glass);
			z-index: 100; display: flex; flex-direction: column; gap: 12px;
			border-radius: 0 0 32px 32px; box-shadow: 0 10px 30px -10px rgba(255,128,171,0.2);
			border-bottom: 1px solid rgba(255,255,255,0.6);
			transform: translateZ(0);
		}
		
		.top-row { display: flex; justify-content: space-between; align-items: center; }
		.logo { 
			font-size: 22px; font-weight: 900; letter-spacing: 1px; 
			background: linear-gradient(45deg, #ff80ab, #b388ff); 
			-webkit-background-clip: text; -webkit-text-fill-color: transparent;
			text-shadow: 0 2px 10px rgba(255, 128, 171, 0.2);
		}
		.status-pill { 
			font-size: 10px; background: #fff; padding: 5px 12px; border-radius: 20px; 
			color: var(--primary); font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
			display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.8);
		}
		.dot { width: 6px; height: 6px; background: #00e676; border-radius: 50%; box-shadow: 0 0 6px #00e676; animation: pulse 2s infinite; }
		@keyframes pulse { 0% {opacity:1;} 50% {opacity:0.5;} 100% {opacity:1;} }

		/* æœç´¢æ¡† (å››çº§è”åŠ¨æ„ŸçŸ¥) */
		.search-box {
			background: #fff; border-radius: 25px; padding: 6px 16px;
			display: flex; align-items: center; transition: 0.3s;
			border: 2px solid transparent; box-shadow: inset 0 2px 6px rgba(0,0,0,0.02);
		}.search-box:focus-within { transform: scale(1.01); border-color: var(--primary); box-shadow: 0 4px 15px rgba(255, 128, 171, 0.2); }
		.search-ipt { border: none; background: transparent; width: 100%; margin-left: 8px; font-size: 14px; color: var(--text); height: 36px; }

		/* ç­›é€‰æµ */
		.filter-container { display: flex; flex-direction: column; gap: 8px; }
		.filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; }
		.chip {
			padding: 5px 14px; background: rgba(255,255,255,0.6); border-radius: 14px; 
			font-size: 11px; font-weight: 700; color: var(--sub); 
			border: 1px solid rgba(255,255,255,0.5); flex-shrink: 0; transition: 0.3s;
		}.chip.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(255, 128, 171, 0.4); border-color: transparent; transform: translateY(-1px); }
		
		/* åŠ¨æ€ç€è‰² */
		.chip.active[data-s="æ•°å­¦"] { background: var(--c-mat); }
		.chip.active[data-s="è‹±è¯­"] { background: var(--c-eng); }
		.chip.active[data-s="è¯­æ–‡"] { background: var(--c-chn); }
		.chip.active[data-s="ç‰©ç†"] { background: var(--c-phy); }

		/* === 3. æ— é™è§†å£ === */
		.viewport { 
			flex: 1; position: relative; overflow-y: auto; 
			will-change: transform; contain: strict; 
			padding-bottom: 140px; z-index: 1;
		}
		.phantom { position: absolute; left: 0; top: 0; right: 0; z-index: -1; }
		
		/* å¡ç‰‡ */
		.card {
			position: absolute; left: 16px; right: 16px; height: 116px;
			background: rgba(255,255,255,0.92); border-radius: 22px;
			box-shadow: 0 4px 15px rgba(149, 157, 165, 0.03);
			border: 1px solid rgba(255,255,255,0.8);
			display: flex; flex-direction: column; justify-content: center; padding: 0 20px;
			transition: transform 0.1s;
		}.card:active { transform: scale(0.98); background: #fff; }
		
		.c-top { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; white-space: nowrap; overflow: hidden;}
		.c-tag { font-size: 10px; color: #fff; padding: 3px 8px; border-radius: 8px; font-weight: 800; flex-shrink: 0;}
		.c-ver { font-size: 10px; color: #aaa; background: #f0f0f0; padding: 2px 6px; border-radius: 6px; text-overflow: ellipsis; overflow: hidden; max-width: 120px;}
		.c-title { font-size: 16px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
		.c-txt { font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
		.c-img-icon { position: absolute; right: 20px; top: 20px; font-size: 12px; }

		/* === 4. åº•éƒ¨ä¸æ‚¬æµ® === */
		.dock {
			position: fixed; bottom: 24px; left: 24px; right: 24px;
			background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
			height: 72px; border-radius: 36px; display: flex; justify-content: space-between; align-items: center;
			padding: 0 35px; box-shadow: 0 15px 40px rgba(0,0,0,0.08); z-index: 90;
			border: 1px solid rgba(255,255,255,0.6);
		}.dock-btn { font-size: 24px; background: none; border: none; opacity: 0.6; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 2px; }
		.dock-btn span { font-size: 10px; font-weight: bold; }
		.dock-btn:active { opacity: 1; transform: scale(1.2); color: var(--primary); }
		
		/* çŒ«å¨˜æ‚¬æµ®çƒ (è‘µ) */
		.neko-fab {
			position: fixed; bottom: 110px; right: 20px; width: 65px; height: 65px;
			background: #fff; border-radius: 50%; 
			display: flex; align-items: center; justify-content: center; font-size: 32px;
			box-shadow: 0 8px 25px rgba(0,0,0,0.1); z-index: 95; border: 2px solid #fff;
			transition: transform 0.3s; cursor: pointer;
		}
		.neko-fab:active { transform: scale(0.9); }
		.neko-badge { position: absolute; top: -5px; right: -5px; background: #ff5252; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; border: 2px solid #fff; font-weight: bold;}

		/* AI èŠå¤©é¢æ¿ */
		.chat-panel {
			position: fixed; bottom: 0; left: 0; right: 0; height: 75vh; background: #fff;
			border-radius: 30px 30px 0 0; z-index: 300; transform: translateY(110%);
			transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
			box-shadow: 0 -10px 50px rgba(0,0,0,0.1); display: flex; flex-direction: column;
		}
		.chat-panel.show { transform: translateY(0); }.chat-head { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
		.chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: #f9f9f9; }
		.msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.6; position: relative; }
		.msg.neko { background: #fff; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); color: #444; }
		.msg.user { background: var(--primary); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 4px 10px rgba(255, 128, 171, 0.3); }
		
		/* åˆ¤å·ç³»ç»Ÿæ ·å¼ */
		.diff-del { text-decoration: line-through; color: #ff5252; background: #ffebee; padding: 0 2px; }
		.diff-add { color: #4caf50; background: #e8f5e9; padding: 0 2px; font-weight: bold; }
		.score-badge { display: inline-block; background: #ffeb3b; color: #f57f17; padding: 2px 8px; border-radius: 12px; font-weight: bold; font-size: 12px; margin-bottom: 5px; }

		.chat-input-area { padding: 15px; background: #fff; display: flex; gap: 10px; align-items: center; padding-bottom: calc(15px + var(--safe-bottom)); }
		.chat-ipt { flex: 1; background: #f0f2f5; border: none; padding: 12px; border-radius: 20px; font-size: 14px; }
		.chat-send { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; border: none; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; }

		/* æ™®é€š FAB */
		.fab {position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
			width: 68px; height: 68px; background: linear-gradient(135deg, #ff80ab, #ff4081);
			border-radius: 50%; display: flex; align-items: center; justify-content: center;
			font-size: 34px; color: #fff; box-shadow: 0 10px 25px rgba(255, 64, 129, 0.4);
			z-index: 100; border: 5px solid #fff0f5; transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
		}
		.fab:active { transform: translateX(-50%) scale(0.9) rotate(90deg); }

		/* === 5. å…¨å±é¢æ¿ç³»ç»Ÿ === */
		.mask { position: fixed; inset: 0; background: rgba(255,240,245,0.5); backdrop-filter: blur(8px); z-index: 200; opacity: 0; pointer-events: none; transition: 0.3s; }
		.mask.show { opacity: 1; pointer-events: auto; }
		
		.panel {
			position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
			border-radius: 32px 32px 0 0; padding: 24px; padding-bottom: calc(30px + var(--safe-bottom));
			z-index: 300; transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
			box-shadow: 0 -10px 50px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 16px;
			max-height: 92dvh;
		}
		.panel.show { transform: translateY(0); }/* è¯¦æƒ…å†…å®¹ */
		.d-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
		.d-btn { font-size: 15px; font-weight: 700; color: var(--primary); border: none; background: none; padding: 10px; }
		.d-scroll { flex: 1; overflow-y: auto; padding: 5px; padding-bottom: 80px; }
		
		.d-card { background: #fcfcfd; border-radius: 24px; padding: 20px; margin-bottom: 15px; border: 1px solid #f5f5f5; }
		.d-label { font-size: 11px; font-weight: 900; color: var(--primary); margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; display: block; }
		.d-txt { font-size: 17px; line-height: 1.7; color: var(--text); white-space: pre-wrap; }
		.math { font-family: monospace; background: #fff; padding: 12px; border-radius: 12px; border: 1px dashed #ffcdd2; color: #880e4f; }
		.d-img { width: 100%; border-radius: 16px; margin-top: 10px; border: 4px solid #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }

		/* ç¼–è¾‘æ§ä»¶ */
		.ipt-row { display: flex; gap: 10px; }
		.ipt { width: 100%; padding: 16px; background: #f7f8fa; border: none; border-radius: 18px; font-size: 15px; color: var(--text); transition: 0.3s; }
		.ipt:focus { background: #fff; box-shadow: 0 0 0 2px var(--primary); }.btn-save { width: 100%; padding: 18px; background: var(--primary); color: #fff; border: none; border-radius: 20px; font-size: 17px; font-weight: 800; box-shadow: 0 8px 20px rgba(255, 128, 171, 0.4); transform: translateY(0); transition: 0.2s; margin-top: 10px; }
		.btn-save:active { transform: scale(0.98); }

		/* åŠ è½½åŠ¨ç”» */
		#boot { position: fixed; inset: 0; background: #fff0f5; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
		.loader-flower { font-size: 60px; animation: breathe 2s infinite ease-in-out; }
		@keyframes breathe { 0%,100% {transform:scale(1); opacity:0.8;} 50% {transform:scale(1.2); opacity:1;} }
	</style>
</head>
<body>

	<div id="boot" style="display: none;">
		<div class="loader-flower">ğŸŒ¸</div>
		<div style="margin-top:20px; font-weight:900; color:#ff80ab; font-size:20px;">Aoi V_Final</div>
		<div style="font-size:12px; color:#bcaaa4; margin-top:8px;">Loading 2025 Knowledge Graph...</div>
	</div><canvas id="sakuraCanvas" width="392" height="386"></canvas>

	<div class="header">
		<div class="top-row">
			<div class="logo">é‚°è‹±æˆçš„æ ¸å¿ƒçŸ¥è¯†ç‚¹èµ„æ–™åº“</div>
			<div class="status-pill"><span class="dot"></span><span id="dbStat">Ready (3)</span></div>
		</div>
		<div class="search-box">
			<span style="font-size:18px; margin-right:5px; color:var(--primary);">ğŸ”</span>
			<input id="sInput" class="search-ipt" placeholder="æ”¯æŒç©ºæ ¼: æ•°å­¦ å¿…ä¿®1 å¯¼æ•°...">
		</div>
		<div class="filter-container">
			<div class="filter-row" id="filterSub"><div class="chip active" onclick="ui.setSub('å…¨éƒ¨')" data-s="å…¨éƒ¨">å…¨éƒ¨</div><div class="chip " onclick="ui.setSub('æ•°å­¦')" data-s="æ•°å­¦">æ•°å­¦</div><div class="chip " onclick="ui.setSub('è‹±è¯­')" data-s="è‹±è¯­">è‹±è¯­</div><div class="chip " onclick="ui.setSub('è¯­æ–‡')" data-s="è¯­æ–‡">è¯­æ–‡</div><div class="chip " onclick="ui.setSub('ç‰©ç†')" data-s="ç‰©ç†">ç‰©ç†</div><div class="chip " onclick="ui.setSub('åŒ–å­¦')" data-s="åŒ–å­¦">åŒ–å­¦</div><div class="chip " onclick="ui.setSub('ç”Ÿç‰©')" data-s="ç”Ÿç‰©">ç”Ÿç‰©</div><div class="chip " onclick="ui.setSub('æ”¿æ²»')" data-s="æ”¿æ²»">æ”¿æ²»</div><div class="chip " onclick="ui.setSub('å†å²')" data-s="å†å²">å†å²</div><div class="chip " onclick="ui.setSub('åœ°ç†')" data-s="åœ°ç†">åœ°ç†</div></div>
			<div class="filter-row" id="filterVer" style="display:none; margin-top:-5px;"></div>
			<div class="filter-row" id="filterMod" style="display:none; margin-top:-5px;"></div>
		</div>
	</div>

	<div class="viewport" id="viewport">
		<div class="phantom" id="phantom"></div>
		<div id="pool"></div>
		<div id="empty" style="text-align:center; color:#ccc; margin-top:150px; display:none; font-weight:bold;">(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡) æš‚æ— ç¬”è®°</div>
	</div><div class="dock">
		<button class="dock-btn" onclick="io.export()">
			<span style="font-size:22px">â˜ï¸</span><span>å¤‡ä»½</span>
		</button>
		<div class="fab" onclick="ui.openEdit()">ï¼‹</div>
		<button class="dock-btn" onclick="document.getElementById('f').click()">
			<span style="font-size:22px">ğŸ“‚</span><span>æ¢å¤</span>
		</button>
	</div>
	<input type="file" id="f" hidden="" onchange="io.import(this)">

	<!-- çŒ«å¨˜å…¥å£ -->
	<div class="neko-fab" onclick="neko.open()">ğŸ±<div class="neko-badge">è‘µ</div></div>

	<!-- AI é¢æ¿ -->
	<div class="mask" id="chatMask" onclick="neko.close()"></div>
	<div class="chat-panel" id="chatPanel">
		<div class="chat-head">
			<span style="font-weight:900; color:#333;">ğŸ± è‘µ (Aoi) - ä½ çš„ä¸“å±å¯¼å¸ˆ</span>
			<button onclick="neko.close()" style="border:none;background:none;color:#999;font-size:20px;">Ã—</button>
		</div>
		<div class="chat-body" id="chatBody">
			<div class="msg neko">
				ä¸»äººå¥½ï¼æˆ‘æ˜¯è‘µ (Aoi)ã€‚<br> <b>âœ¨ æˆ‘èƒ½å¸®ä½ ï¼š</b><br>
				1. <b>æ™ºèƒ½åˆ¤å·</b>ï¼šå‘é€â€œèƒŒè¯µã€Šé˜¿æˆ¿å®«èµ‹ã€‹â€ï¼Œç„¶åé»˜å†™ï¼Œæˆ‘ä¼šé€å­—çº é”™æ‰“åˆ†ã€‚<br>
				2. <b>æ·±åº¦è®²è§£</b>ï¼šç‚¹å‡»ç¬”è®°çš„â€œğŸ§ è®²è§£â€ï¼Œæˆ‘ä¼šç”¨æ¸…åŒ—é€»è¾‘ä¸ºä½ å‰–æã€‚<br>
				3. <b>å…¨åº“ç§’æœ</b>ï¼šå‘é€â€œæœ æ•°å­¦ å¯¼æ•°â€ï¼Œç²¾å‡†å®šä½çŸ¥è¯†ç‚¹ã€‚
			</div>
		</div>
		<div class="chat-input-area">
			<input id="chatIpt" class="chat-ipt" placeholder="å’Œè‘µè¯´ç‚¹ä»€ä¹ˆ...">
			<button class="chat-send" onclick="neko.send()">â†‘</button>
		</div>
	</div>

	<!-- è¯¦æƒ…é¡µ -->
	<div class="mask" id="detailMask" onclick="ui.closeDetail()"></div>
	<div class="panel" id="detailPanel" style="height:92vh;">
		<div class="d-nav">
			<button class="d-btn" onclick="ui.closeDetail()" style="color:#999;">â† è¿”å›</button>
			<span style="font-weight:900; color:var(--text);">ç¬”è®°è¯¦æƒ…</span>
			<button class="d-btn" style="color:#ff5252" onclick="core.del()">åˆ é™¤</button>
		</div>
		<div class="d-scroll">
			<div class="d-card">
				<span class="d-label">ğŸ’¡ æ ¸å¿ƒè€ƒç‚¹</span>
				<div class="d-txt" id="dApp" style="font-weight:900; font-size:22px;"></div>
			</div>
			<div class="d-card">
				<span class="d-label">ğŸ“˜ è¯¦ç»†è§£æ / å…¬å¼</span>
				<div class="d-txt math" id="dKwd"></div>
			</div>
			<div class="d-card" id="dErrBox">
				<span class="d-label" style="color:#ef5350">âš ï¸ æ˜“é”™ / å¯¼å¸ˆç‚¹æ‹¨</span><div class="d-txt" id="dErr" style="color:#5d4037"></div>
			</div>
			<img id="dImg" class="d-img" style="display:none">
			<button onclick="neko.speakCurrent()" style="width:100%; padding:15px; background:#f3e5f5; border:none; border-radius:16px; font-weight:bold; color:#7b1fa2; margin-top:10px; box-shadow:0 4px 10px rgba(0,0,0,0.05);">ğŸ§ è®©è‘µè®²è§£ (TTS)</button>
		</div>
	</div>

	<!-- ç¼–è¾‘é¡µ -->
	<div class="mask" id="editMask" onclick="ui.closeEdit()"></div>
	<div class="panel" id="editPanel">
		<div style="text-align:center; font-weight:900; color:var(--text); margin-bottom:10px; font-size:18px;">âœ¨ çŸ¥è¯†å½•å…¥</div>
		<div class="ipt-row">
			<select id="iSub" class="ipt" style="flex:1; font-weight:bold;" onchange="ui.upVer()"><option value="æ•°å­¦">æ•°å­¦</option><option value="è‹±è¯­">è‹±è¯­</option><option value="è¯­æ–‡">è¯­æ–‡</option><option value="ç‰©ç†">ç‰©ç†</option><option value="åŒ–å­¦">åŒ–å­¦</option><option value="ç”Ÿç‰©">ç”Ÿç‰©</option><option value="æ”¿æ²»">æ”¿æ²»</option><option value="å†å²">å†å²</option><option value="åœ°ç†">åœ°ç†</option></select>
			<select id="iVer" class="ipt" style="flex:1" onchange="ui.upMod()"></select>
			<select id="iMod" class="ipt" style="flex:1"></select>
		</div>
		<input id="iApp" class="ipt" placeholder="ğŸ’¡ æ ‡é¢˜ (å¿…å¡«)">
		<textarea id="iKwd" class="ipt" style="height:120px" placeholder="ğŸ“˜ å†…å®¹ (æ”¯æŒå…¬å¼ AsciiMath)"></textarea>
		<textarea id="iErr" class="ipt" style="height:80px" placeholder="âš ï¸ å¤‡æ³¨ / å‚è€ƒå›¾è¯´æ˜"></textarea>
		<div style="display:flex; justify-content:space-between; align-items:center; padding:0 10px;">
			<span style="font-size:12px; color:#999;" id="imgTip">ğŸ“· æš‚æ— å›¾ç‰‡</span>
			<buttononclick="document.getelementbyid('cam').click()" style="background:#fff; border:1px solid #ddd; padding:6px 15px; border-radius:12px; font-size:12px; font-weight:bold; color:var(--text);">æ·»åŠ å›¾ç‰‡
		</buttononclick="document.getelementbyid('cam').click()"></div>
		<input type="file" id="cam" hidden="" accept="image/*" onchange="core.img(this)">
		<button class="btn-save" onclick="core.save()">ä¿å­˜åˆ°æ°¸æ’åº“</button>
	</div>

<script>
	/**
	 * V_Final_Aoi ç»ˆæå†…æ ¸
	 * åŒ…å«: Workerå¤šçº¿ç¨‹, Neko-Core 2.0 (Diffç®—æ³•), 2025å…¨æ•™æç´¢å¼•, ç‰©ç†ç²’å­
	 */
	
	const CFG = {
		sub: ['å…¨éƒ¨','æ•°å­¦','è‹±è¯­','è¯­æ–‡','ç‰©ç†','åŒ–å­¦','ç”Ÿç‰©','æ”¿æ²»','å†å²','åœ°ç†'],
		col: {'æ•°å­¦':'#42a5f5','è‹±è¯­':'#ab47bc','è¯­æ–‡':'#f06292','ç‰©ç†':'#9575cd','åŒ–å­¦':'#ef5350','ç”Ÿç‰©':'#81c784','æ”¿æ²»':'#ff7043','å†å²':'#8d6e63','åœ°ç†':'#26a69a'},
		// 2025 æ–°è¯¾æ ‡å…¨ç½‘æ•™ææ˜ å°„
		ver: {
			'æ•°å­¦':['é€šç”¨','äººæ•™Aç‰ˆ','äººæ•™Bç‰ˆ','åŒ—å¸ˆå¤§ç‰ˆ','è‹æ•™ç‰ˆ','æ¹˜æ•™ç‰ˆ'],
			'è‹±è¯­':['é€šç”¨','äººæ•™ç‰ˆ','å¤–ç ”ç‰ˆ','åŒ—å¸ˆå¤§ç‰ˆ','ç‰›æ´¥ç‰ˆ','é«˜è€ƒ3500è¯'],
			'è¯­æ–‡':['é€šç”¨','äººæ•™ç‰ˆ','è‹æ•™ç‰ˆ','é²æ•™ç‰ˆ','è¯­æ–‡ç‰ˆ'],
			'ç‰©ç†':['é€šç”¨','äººæ•™ç‰ˆ','é²ç§‘ç‰ˆ','æ•™ç§‘ç‰ˆ','æ²ªç§‘ç‰ˆ'],
			'åŒ–å­¦':['é€šç”¨','äººæ•™ç‰ˆ','é²ç§‘ç‰ˆ','è‹æ•™ç‰ˆ'],
			'ç”Ÿç‰©':['é€šç”¨','äººæ•™ç‰ˆ','è‹æ•™ç‰ˆ','åŒ—å¸ˆå¤§ç‰ˆ'],
			'æ”¿æ²»':['é€šç”¨','äººæ•™ç‰ˆ (ç»Ÿç¼–)'],
			'å†å²':['é€šç”¨','äººæ•™ç‰ˆ (ä¸­å¤–çº²è¦)'],
			'åœ°ç†':['é€šç”¨','äººæ•™ç‰ˆ','æ¹˜æ•™ç‰ˆ','é²æ•™ç‰ˆ','ä¸­å›¾ç‰ˆ']
		},mod: ['å¿…ä¿®1','å¿…ä¿®2','å¿…ä¿®3','å¿…ä¿®4','é€‰æ‹©æ€§å¿…ä¿®1','é€‰æ‹©æ€§å¿…ä¿®2','é€‰æ‹©æ€§å¿…ä¿®3','é€‰ä¿®'],
		H: 118, N: 16
	};

	// Worker Blob
	const workerBlob = new Blob([`
		const DB='Sakura_Aoi_DB'; let db, idx=[];
		self.onmessage = async e => {
			const {t,d,u} = e.data;
			try {
				if(t==='I') { await open(); idx=await load(); post(u, idx.length); }
				else if(t==='S') post(u, search(d));
				else if(t==='G') post(u, await get(d));
				else if(t==='W') { await put(d); up(d); post(u,1); }
				else if(t==='D') { await del(d); idx=idx.filter(x=>x.i!==d); post(u,1); }
				else if(t==='E') post(u, await all());
				else if(t==='M') { await batch(d); idx=await load(); post(u,1); }
				else if(t==='AI_DIFF') post(u, diffCheck(d.ans, d.std));
				else if(t==='AI_Q') post(u, await aiQuery(d));
			} catch(err){ post(u,null,err.message) }
		};function post(u,d,e){self.postMessage({u,d,e})}
		function open(){return new Promise((r,j)=>{const q=indexedDB.open(DB,1);q.onupgradeneeded=e=>{const d=e.target.result;d.createObjectStore('n',{keyPath:'id'});d.createObjectStore('sys',{keyPath:'id'});};q.onsuccess=e=>{db=e.target.result;r()};q.onerror=j})}
		function load(){return new Promise(r=>{const t=[];db.transaction('n').objectStore('n').openCursor().onsuccess=e=>{const c=e.target.result;if(c){t.push({i:c.value.id,s:c.value.sub,v:c.value.ver,m:c.value.mod,a:c.value.app,k:c.value.kwd});c.continue()}else r(t.sort((x,y)=>y.i-x.i))}})}
		function search({s,v,m,k}){
			let r=idx;
			if(s!=='å…¨éƒ¨')r=r.filter(x=>x.s===s);
			if(v!=='å…¨éƒ¨')r=r.filter(x=>x.v===v);
			if(m!=='å…¨éƒ¨')r=r.filter(x=>x.m===m);
			if(k){const keys=k.toLowerCase().split(' ');r=r.filter(x=>keys.every(key=>(x.a+x.k+x.s).toLowerCase().includes(key)))}
			return r.map(x=>x.i);
		}
		function get(ids){return Promise.all(ids.map(i=>new Promise(r=>db.transaction('n','readonly').objectStore('n').get(i).onsuccess=e=>r(e.target.result))))}
		function put(v){return new Promise(r=>db.transaction('n','readwrite').objectStore('n').put(v).oncomplete=r)}
		function del(i){return new Promise(r=>db.transaction('n','readwrite').objectStore('n').delete(i).oncomplete=r)}
		function all(){return new Promise(r=>db.transaction('n').objectStore('n').getAll().onsuccess=e=>r(e.target.result))}
		function batch(d){return new Promise(r=>{const tx=db.transaction('n','readwrite');d.forEach(i=>tx.objectStore('n').put(i));tx.oncomplete=r})}
		function up(v){const i=idx.findIndex(x=>x.i===v.id);if(i>-1)idx.splice(i,1);idx.unshift({i:v.id,s:v.sub,v:v.ver,m:v.mod,a:v.app,k:v.kwd})}// AI Core (Neko)
		async function aiQuery(q) {
			if(q.includes('æœ')) {
				const k = q.replace('æœ','').replace('ç´¢','').trim();
				const res = idx.filter(x=>(x.a+x.k).includes(k)).slice(0,3);
				return { type: 'SEARCH', data: res };
			}
			if(q.includes('èƒŒ') || q.includes('æŠ½')) {
				const sub = q.includes('è‹±è¯­')||q.includes('å•è¯')?'è‹±è¯­':'è¯­æ–‡';
				const arr = idx.filter(x=>x.s===sub);
				if(!arr.length) return { type: 'MSG', msg: 'å–µ~ ä½ çš„'+sub+'åº“æ˜¯ç©ºçš„ï¼Œå…ˆå»æ·»åŠ ç‚¹ç¬”è®°å§ï¼' };
				const item = arr[Math.floor(Math.random()*arr.length)];
				return { type: 'QUIZ', item: item };
			}
			if(q.startsWith('ANS:')) {
				const [ans, right] = q.substring(4).split('|||');
				return { type: 'SCORE', res: diffCheck(ans, right), right: right };
			}
			return { type: 'MSG', msg: 'å–µï¼Ÿä½ å¯ä»¥è¯´â€œèƒŒå•è¯â€ã€â€œæŠ½æŸ¥è¯­æ–‡â€æˆ–è€…â€œæœç´¢ xxxâ€å“¦~' };
		}

		function diffCheck(ans, std) {
			let s1=ans.trim(), s2=std.trim();
			if(s1===s2) return { score:100, html:'å®Œç¾ï¼å…¨å¯¹ï¼' };
			let html = ''; let i=0;
			for(let char of s2) {
				if(s1[i] === char) { html += char; i++; }
				else { html += '<span class="diff-del">'+char+'</span>'; }
			}
			const score = Math.max(0, Math.floor((1 - (s2.length-i)/s2.length)*100));
			return { score, html: html + (i<s1.length ? '<span class="diff-add">'+s1.substring(i)+'</span>' : '') };
		}
	`], {type:'text/javascript'});

	const worker = new Worker(URL.createObjectURL(workerBlob));
	const api = (t,d)=>new Promise((r,j)=>{const u=Math.random().toString(36).slice(2);const h=e=>{if(e.data.u===u){worker.removeEventListener('message',h);e.data.e?j(e.data.e):r(e.data.d)}};worker.addEventListener('message',h);worker.postMessage({t,d,u})}); let S = { sub:'å…¨éƒ¨', ver:'å…¨éƒ¨', mod:'å…¨éƒ¨', ids:[], cur:null, img:null, h:0, scroll:0 };
	let quizItem = null;

	// --- ç‰©ç†å¼•æ“ ---
	function startSakura() {
		const c = document.getElementById('sakuraCanvas');
		const ctx = c.getContext('2d');
		let w, h, p=[];
		const rs = () => { w=c.width=window.innerWidth; h=c.height=window.innerHeight; };
		window.addEventListener('resize', rs); rs();
		for(let i=0;i<25;i++) p.push({x:Math.random()*w,y:Math.random()*h,s:Math.random()*5+8,v:Math.random()+0.5,a:Math.random()*360,va:Math.random()*2-1});
		function anim() {
			ctx.clearRect(0,0,w,h);
			p.forEach(i=>{
				i.y+=i.v; i.a+=i.va;
				if(i.y>h) i.y=-20;
				ctx.save(); ctx.translate(i.x,i.y); ctx.rotate(i.a*Math.PI/180);
				ctx.fillStyle='rgba(255,192,203,0.5)';
				ctx.beginPath(); ctx.moveTo(0,0); ctx.bezierCurveTo(i.s, -i.s, i.s*2, 0, 0, i.s*2); ctx.fill();
				ctx.restore();
			});
			requestAnimationFrame(anim);
		}
		anim();
	}

	// --- Virtual List ---
	const Pool = {
		els: [],init() {
			const c = document.getElementById('pool');
			for(let i=0; i<CONFIG.N; i++){
				const d = document.createElement('div');
				d.className = 'card';
				d.style.transform = 'translate3d(0,-500px,0)';
				d.innerHTML = `<div class="card-content"><div class="c-top"><span class="c-tag"></span><span class="c-ver"></span></div><div class="c-title"></div><div class="c-txt"></div></div>`;
				d.onclick = ()=>ui.detail(d.dataset.id);
				c.appendChild(d);
				this.els.push(d);
			}
		},
		render(start) {
			const end = Math.min(start + CONFIG.N, S.ids.length);
			const ids = S.ids.slice(start, end);
			api('GET', ids).then(items => {
				items.forEach((item, i) => {
					const el = this.els[i];
					const top = (start + i) * CONFIG.H;
					if(el.dataset.idx != (start+i)) {
						el.style.transform = `translate3d(0,${top}px,0)`;
						el.dataset.idx = start + i;
						el.dataset.id = item.id;
						el.querySelector('.c-tag').style.backgroundColor = CONFIG.col[item.sub]||'#999';
						el.querySelector('.c-tag').innerText = item.sub;
						el.querySelector('.c-ver').innerText = item.ver + ' Â· ' + item.mod;
						el.querySelector('.c-title').innerText = item.app;
						el.querySelector('.c-txt').innerText = item.kwd.substring(0,25);
					}
				});for(let i=items.length; i<CONFIG.N; i++) this.els[i].style.transform = 'translate3d(0,-500px,0)';
			});
		}
	};

	// --- Main ---
	window.onload = async () => {
		startSakura();
		const n = await api('I');
		document.getElementById('boot').style.display='none';
		document.getElementById('dbStat').innerText = `Ready (${n})`;
		if(n===0) await core.inject();
		ui.init(); Pool.init();
		const vp = document.getElementById('viewport');
		vp.addEventListener('scroll', e => { S.scroll=e.target.scrollTop; requestAnimationFrame(render); });
		window.addEventListener('resize', () => { S.h=vp.clientHeight; render(); });
		S.h = vp.clientHeight;
		search();
	};

	function render() {
		const start = Math.floor(S.scroll / CONFIG.H);
		Pool.render(Math.max(0, start-2));
	}

	async function search() {
		const key = document.getElementById('sInput').value.trim();
		S.ids = await api('S', {s:S.sub, v:S.ver, m:S.mod, k:key});
		document.getElementById('phantom').style.height = `${S.ids.length * CONFIG.H + 100}px`;
		document.getElementById('empty').style.display = S.ids.length ? 'none' : 'block';
		render();
	} // --- Neko AI ---
	const neko = {
		open: () => { document.getElementById('chatMask').classList.add('show'); document.getElementById('chatPanel').classList.add('show'); },
		close: () => { document.getElementById('chatMask').classList.remove('show'); document.getElementById('chatPanel').classList.remove('show'); },
		send: async () => {
			const ipt = document.getElementById('chatIpt');
			const txt = ipt.value.trim();
			if(!txt) return;
			neko.addMsg(txt, 'user');
			ipt.value = '';

			// åˆ¤å·
			if(quizItem) {
				const res = await api('AI_DIFF', {ans:txt, std:quizItem.kwd});
				neko.addMsg(`<span class="score-badge">${res.res.score}åˆ†</span><br>æ ‡å‡†ï¼š${quizItem.kwd}<br>ä½ çš„ï¼š${res.res.html}`, 'neko');
				if(res.res.score < 85) neko.speakText("å“å‘€ï¼Œè¿˜è¦åŠ æ²¹å“¦ï¼è¦æ³¨æ„çº¢è‰²æ ‡è®°çš„åœ°æ–¹ã€‚");
				else neko.speakText("å¤ªæ£’äº†ï¼Œå…¨å¯¹ï¼");
				quizItem = null;
				return;
			} const res = await api('AI_Q', txt);
			if(res.type === 'MSG') {
				neko.addMsg(res.msg, 'neko');
				neko.speakText(res.msg);
			} else if(res.type === 'SEARCH') {
				neko.addMsg(`æ‰¾åˆ°å•¦ï¼š\n${res.data.map(x=>"Â· "+x.app).join('\n')}`, 'neko');
			} else if(res.type === 'QUIZ') {
				quizItem = res.item;
				neko.addMsg(`ã€æŠ½æŸ¥ã€‘\nç§‘ç›®ï¼š${quizItem.s}\né¢˜ç›®ï¼š${quizItem.a}\nè¯·èƒŒè¯µå†…å®¹ï¼š`, 'neko');
				neko.speakText("è¯·èƒŒè¯µï¼š"+quizItem.a);
			}
		},
		addMsg: (html, type) => {
			const d = document.createElement('div');
			d.className = `msg ${type}`;
			d.innerHTML = html;
			document.getElementById('chatBody').appendChild(d);
			document.getElementById('chatBody').scrollTop = 9999;
		},
		speakText: (txt) => {
			window.speechSynthesis.cancel();
			const u = new SpeechSynthesisUtterance(txt);
			u.rate = 0.9; u.pitch = 1.2; 
			window.speechSynthesis.speak(u);
		},
		speakCurrent: () => {
			if(!S.cur) return;
			const intro = `ç°åœ¨è®²è§£ï¼Œ${S.cur.sub}ï¼Œ${S.cur.app}ã€‚`;
			const content = `æ ¸å¿ƒå†…å®¹æ˜¯ï¼š${S.cur.kwd}ã€‚`;
			const tip = S.cur.err ? `è¯·ç‰¹åˆ«æ³¨æ„ï¼š${S.cur.err}` : '';
			neko.speakText(intro + content + tip);
		}
	}; const core = {
		save: async () => {
			const d = {
				id: Date.now(),
				sub: document.getElementById('iSub').value,
				ver: document.getElementById('iVer').value,
				mod: document.getElementById('iMod').value,
				app: document.getElementById('iApp').value,
				kwd: document.getElementById('iKwd').value,
				err: document.getElementById('iErr').value,
				img: S.img
			};
			if(!d.app) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©ºå“¦');
			await api('W', d);
			ui.closeEdit(); search();
		},
		del: async () => { if(confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) { await api('D', S.cur.id); ui.closeDetail(); search(); } },
		inject: async () => {
			const d = [
				{id:1,sub:"æ•°å­¦",ver:"äººæ•™Aç‰ˆ",mod:"å¿…ä¿®1",app:"ã€å‡½æ•°ã€‘å•è°ƒæ€§å®šä¹‰",kwd:"x1<x2 => f(x1)<f(x2) (å¢)",err:"æ³¨æ„å®šä¹‰åŸŸ"},
				{id:2,sub:"è‹±è¯­",ver:"é«˜è€ƒ3500è¯",mod:"å¿…ä¿®1",app:"abandon",kwd:"v. æŠ›å¼ƒï¼Œæ”¾å¼ƒ",err:"abandon oneself to æ²‰æººäº"},
				{id:3,sub:"è¯­æ–‡",ver:"äººæ•™ç‰ˆ",mod:"å¿…ä¿®ä¸Š",app:"ã€å¤è¯—ã€‘çŸ­æ­Œè¡Œ",kwd:"å¯¹é…’å½“æ­Œï¼Œäººç”Ÿå‡ ä½•",err:"æ›¹æ“"}
			];
			await api('M', d);
		},
		img: (ipt) => {
			const f = ipt.files[0]; if(!f) return;
			const r = new FileReader();
			r.onload = e => {
				const img = new Image(); img.src = e.target.result;
				img.onload = () => {
					const c = document.createElement('canvas');
					const x = c.getContext('2d');
					const sc = 1000/img.width;
					c.width=1000; c.height=img.height*sc;
					x.drawImage(img,0,0,c.width,c.height);
					S.img = c.toDataURL('image/webp', 0.7);
					document.getElementById('imgTip').innerText = 'âœ… å·²å‹ç¼©';
				}
			}; r.readAsDataURL(f);
		}
	};const io = {
		export: async () => {
			const d = await api('E');
			const b = new Blob([JSON.stringify(d)],{type:'application/json'});
			const u = URL.createObjectURL(b);
			const a = document.createElement('a'); a.href=u; a.download=`Sakura_${Date.now()}.json`; a.click();
		},
		import: (ipt) => {
			const r = new FileReader();
			r.readAsText(ipt.files[0]);
			r.onload = async e => {
				try {
					const d = JSON.parse(e.target.result);
					if(confirm(`å¯¼å…¥${d.length}æ¡ï¼Ÿ`)) { await api('M', d); search(); alert('æˆåŠŸ âœ¨'); }
				} catch(e){ alert('æ–‡ä»¶é”™å•¦'); }
			}
		}
	};

	const ui = {
		init: () => {
			document.getElementById('filterSub').innerHTML = CFG.sub.map(s => 
				`<div class="chip ${s===S.sub?'active':''}" onclick="ui.setSub('${s}')" data-s="${s}">${s}</div>`
			).join('');
			const sel = document.getElementById('iSub');
			CFG.sub.slice(1).forEach(s => sel.add(new Option(s,s)));
		},
		setSub: (s) => { S.sub = s; S.ver='å…¨éƒ¨'; S.mod='å…¨éƒ¨'; ui.renderVer(); ui.renderMod(); search(); },
		renderVer: () => {
			const box = document.getElementById('filterVer');
			if(S.sub==='å…¨éƒ¨') { box.style.display='none'; return; }
			box.style.display='flex';
			const vs = ['å…¨éƒ¨', ...(CFG.ver[S.sub]||['é€šç”¨'])];
			box.innerHTML = vs.map(v => `<div class="chip ${v===S.ver?'active':''}" onclick="ui.setVer('${v}')">${v}</div>`).join('');
		},setVer: (v) => { S.ver = v; S.mod='å…¨éƒ¨'; ui.renderVer(); ui.renderMod(); search(); },
		renderMod: () => {
			const box = document.getElementById('filterMod');
			if(S.ver==='å…¨éƒ¨') { box.style.display='none'; return; }
			box.style.display='flex';
			const ms = ['å…¨éƒ¨', ...CFG.mod];
			box.innerHTML = ms.map(m => `<div class="chip ${m===S.mod?'active':''}" onclick="ui.setMod('${m}')">${m}</div>`).join('');
		},
		setMod: (m) => { S.mod = m; ui.renderMod(); search(); },
		
		detail: async (id) => {
			const items = await api('G', [parseInt(id)]);
			const i = items[0]; S.cur = i;
			document.getElementById('dApp').innerText = i.app;
			document.getElementById('dKwd').innerText = i.kwd;
			document.getElementById('dErr').innerText = i.err || 'æ— ';
			document.getElementById('dErrBox').style.display = i.err ? 'block' : 'none';
			const img = document.getElementById('dImg');
			if(i.img) { img.src=i.img; img.style.display='block'; } else img.style.display='none';document.getElementById('detailPanel').classList.add('show');
			document.getElementById('detailMask').classList.add('show');
		},
		closeDetail: () => {
			document.getElementById('detailPanel').classList.remove('show');
			document.getElementById('detailMask').classList.remove('show');
			window.speechSynthesis.cancel();
		},
		openEdit: () => {
			document.getElementById('editMask').classList.add('show');
			document.getElementById('editPanel').classList.add('show');
			ui.upVer(); ui.upMod();
		},
		closeEdit: () => {
			document.getElementById('editMask').classList.remove('show');
			document.getElementById('editPanel').classList.remove('show');
			document.getElementById('iApp').value=''; S.img=null;
		},
		upVer: () => {
			const s = document.getElementById('iSub').value;
			const v = document.getElementById('iVer');
			v.innerHTML = '';
			(CFG.ver[s]||['é€šç”¨']).forEach(x => v.add(new Option(x,x)));
			ui.upMod();
		},
		upMod: () => {
			const m = document.getElementById('iMod');
			m.innerHTML = '';
			CFG.mod.forEach(x => m.add(new Option(x,x)));
		}
	};
	
	let st; document.getElementById('sInput').oninput = () => { clearTimeout(st); st=setTimeout(search, 200); };
</script>

</body></html>